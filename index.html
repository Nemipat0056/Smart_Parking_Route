<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Parking Route - Intelligent Parking Solutions</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-greeting {
      font-weight: 500;
    }

    .logout-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #ff5252;
      transform: translateY(-1px);
    }

    .main-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .auth-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .auth-section.authenticated {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid #4caf50;
    }

    .tab-container {
      display: flex;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 0.5rem;
      margin-bottom: 2rem;
      overflow-x: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      gap: 0.5rem;
    }

    .tab-button {
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-weight: 500;
      white-space: nowrap;
      min-width: fit-content;
    }

    .tab-button:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .tab-button.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .route-section, .search-section, .booking-section {
      margin-bottom: 2rem;
    }

    .route-input-group, .search-input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    input[type="text"], input[type="datetime-local"], select {
      flex: 1;
      min-width: 200px;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: fit-content;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .map-container {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      margin: 1rem 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .route-options, .parking-filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .route-options label, .parking-filters label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .info, .error, .success {
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      font-weight: 500;
    }

    .info {
      background: rgba(33, 150, 243, 0.1);
      color: #1976d2;
      border-left: 4px solid #2196f3;
    }

    .error {
      background: rgba(244, 67, 54, 0.1);
      color: #d32f2f;
      border-left: 4px solid #f44336;
    }

    .success {
      background: rgba(76, 175, 80, 0.1);
      color: #388e3c;
      border-left: 4px solid #4caf50;
    }

    .results-section {
      margin-top: 2rem;
    }

    .route-item {
      background: rgba(102, 126, 234, 0.05);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 1px solid rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
    }

    .route-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .route-item h5 {
      margin-bottom: 0.5rem;
      color: #667eea;
    }

    .select-route-btn {
      background: #4caf50;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    .parking-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .parking-spot {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid #e0e0e0;
    }

    .parking-spot:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .parking-spot h5 {
      color: #667eea;
      margin-bottom: 1rem;
    }

    .parking-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .book-spot-btn {
      width: 100%;
      margin-top: 1rem;
      background: #ff9800;
    }

    .book-spot-btn:hover {
      background: #f57c00;
    }

    .debug {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .main-container {
        padding: 0 1rem;
      }

      .tab-container {
        flex-direction: column;
      }

      .route-input-group, .search-input-group {
        flex-direction: column;
      }

      .parking-results-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">üÖøÔ∏è Smart Parking Route</div>
    <div class="user-section">
      <div id="userGreeting" class="user-greeting">Loading...</div>
      <button id="logoutBtn" class="logout-btn" style="display: none;">Logout</button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Authentication Status -->
    <div id="authSection" class="auth-section">
      <h3>üîê Authentication Status</h3>
      <div id="authStatus">Checking authentication status...</div>
      <div id="debugInfo" class="debug" style="display: none;"></div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <div id="routeTabBtn" class="tab-button active">üó∫Ô∏è Route Planning</div>
      <div id="parkingTabBtn" class="tab-button">üÖøÔ∏è Parking Search</div>
    </div>

    <!-- Route Planning Tab -->
    <div id="routeTabContent" class="tab-content active">
      <div class="route-section">
        <h3>üó∫Ô∏è Plan Your Smart Route</h3>
        
        <div class="route-input-group">
          <input type="text" id="startLocationInput" placeholder="Enter starting location" />
          <input type="text" id="destinationInput" placeholder="Enter destination" />
          <button id="findRouteBtn">Find Best Route</button>
        </div>
        
        <div class="route-options">
          <label>
            <input type="checkbox" id="includeParking" checked> Include parking spots
          </label>
          <label>
            <input type="checkbox" id="avoidToll"> Avoid toll roads
          </label>
          <label>
            <input type="checkbox" id="ecoFriendly"> Eco-friendly route
          </label>
        </div>
        
        <div id="routeStatus" class="info">Enter locations to plan your route</div>
        
        <!-- Google Map for Route Planning -->
        <div id="routeMap" class="map-container"></div>
        
        <!-- Route Results -->
        <div id="routeResults" class="results-section" style="display: none;">
          <h4>Suggested Routes</h4>
          <div id="routesList" class="routes-list"></div>
        </div>
      </div>
    </div>

    <!-- Parking Search Tab -->
    <div id="parkingTabContent" class="tab-content">
      <h3>üÖøÔ∏è Find Parking Spots</h3>
      
      <!-- Search Section -->
      <div class="search-section">
        <h4>Search for Parking</h4>
        <div class="search-input-group">
          <input type="text" id="parkingLocationInput" placeholder="Enter location or address" />
          <select id="parkingTypeSelect">
            <option value="all">All Types</option>
            <option value="street">Street Parking</option>
            <option value="garage">Parking Garage</option>
            <option value="lot">Parking Lot</option>
            <option value="private">Private Parking</option>
          </select>
          <button id="searchParkingBtn">Search Parking</button>
        </div>
        
        <div class="parking-filters">
          <label>Max Distance: 
            <select id="maxDistanceSelect">
              <option value="0.5">0.5 km</option>
              <option value="1" selected>1 km</option>
              <option value="2">2 km</option>
              <option value="5">5 km</option>
            </select>
          </label>
          
          <label>Price Range: 
            <select id="priceRangeSelect">
              <option value="all">Any Price</option>
              <option value="free">Free</option>
              <option value="low">$0-$5/hour</option>
              <option value="medium">$5-$15/hour</option>
              <option value="high">$15+/hour</option>
            </select>
          </label>
        </div>
        
        <div id="parkingSearchStatus" class="info">Ready to search for parking spots</div>
        
        <!-- Google Map for Parking Search -->
        <div id="parkingMap" class="map-container"></div>
      </div>

      <!-- Parking Results Section -->
      <div id="parkingResultsSection" class="results-section" style="display: none;">
        <h4>Available Parking Spots</h4>
        <div id="parkingResultsCount" class="results-count"></div>
        <div id="parkingResultsGrid" class="parking-results-grid"></div>
      </div>
    </div>
  </div>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMaps"></script>

  <script>
    // Google Maps Configuration
    let routeMap;
    let parkingMap;
    let directionsService;
    let directionsRenderer;
    let placesService;
    let routeAutocompleteStart;
    let routeAutocompleteDestination;
    let parkingAutocomplete;
    let parkingMarkers = [];

    // Melbourne CBD coordinates
    const MELBOURNE_CBD = { lat: -37.8136, lng: 144.9631 };

    // Cognito Configuration
    const COGNITO_CONFIG = {
      userPoolId: 'ap-southeast-2_WUGCMLsul',
      clientId: '142bk2r1bg5rjpfmbstismulh9',
      region: 'ap-southeast-2',
      domain: 'cognito-idp.ap-southeast-2.amazonaws.com',
      redirectUri: 'https://main.d1n04r9iix2vet.amplifyapp.com/',
      logoutUri: 'https://main.d1n04r9iix2vet.amplifyapp.com/',
      scopes: ['openid', 'email', 'phone']
    };

    // Global variables
    let userTokens = null;
    let isAuthenticated = false;
    let currentRoute = null;

    // DOM elements
    const tabs = {
      route: { btn: document.getElementById('routeTabBtn'), content: document.getElementById('routeTabContent') },
      parking: { btn: document.getElementById('parkingTabBtn'), content: document.getElementById('parkingTabContent') }
    };

    const authSection = document.getElementById('authSection');
    const authStatus = document.getElementById('authStatus');
    const userGreeting = document.getElementById('userGreeting');
    const logoutBtn = document.getElementById('logoutBtn');
    const debugInfo = document.getElementById('debugInfo');

    // Debug mode
    const DEBUG_MODE = true;

    function debugLog(message, data = null) {
      if (DEBUG_MODE) {
        console.log(`[Smart Parking Route DEBUG] ${message}`, data);
        if (debugInfo) {
          debugInfo.style.display = 'block';
          debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
          if (data) {
            debugInfo.innerHTML += `<div>Data: ${JSON.stringify(data, null, 2)}</div>`;
          }
        }
      }
    }

    // Initialize Google Maps
    function initMaps() {
      debugLog('Initializing Google Maps');
      
      // Initialize route planning map
      routeMap = new google.maps.Map(document.getElementById('routeMap'), {
        zoom: 13,
        center: MELBOURNE_CBD,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      // Initialize parking search map
      parkingMap = new google.maps.Map(document.getElementById('parkingMap'), {
        zoom: 15,
        center: MELBOURNE_CBD,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      // Initialize directions service
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true,
        panel: document.getElementById('routesList')
      });
      directionsRenderer.setMap(routeMap);

      // Initialize places service
      placesService = new google.maps.places.PlacesService(parkingMap);

      // Setup autocomplete for route inputs
      routeAutocompleteStart = new google.maps.places.Autocomplete(
        document.getElementById('startLocationInput'),
        {
          bounds: new google.maps.LatLngBounds(
            new google.maps.LatLng(-37.9, 144.8),
            new google.maps.LatLng(-37.7, 145.1)
          ),
          strictBounds: true
        }
      );

      routeAutocompleteDestination = new google.maps.places.Autocomplete(
        document.getElementById('destinationInput'),
        {
          bounds: new google.maps.LatLngBounds(
            new google.maps.LatLng(-37.9, 144.8),
            new google.maps.LatLng(-37.7, 145.1)
          ),
          strictBounds: true
        }
      );

      // Setup autocomplete for parking search
      parkingAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('parkingLocationInput'),
        {
          bounds: new google.maps.LatLngBounds(
            new google.maps.LatLng(-37.9, 144.8),
            new google.maps.LatLng(-37.7, 145.1)
          ),
          strictBounds: true
        }
      );

      parkingAutocomplete.addListener('place_changed', onParkingLocationSelected);

      debugLog('Google Maps initialized successfully');
      
      // Initialize authentication after maps are ready
      initAuth();
    }

    // Handle parking location selection
    function onParkingLocationSelected() {
      const place = parkingAutocomplete.getPlace();
      if (!place.geometry) return;

      parkingMap.setCenter(place.geometry.location);
      parkingMap.setZoom(16);
      
      // Search for nearby parking automatically
      searchNearbyParking(place.geometry.location);
    }

    // Tab switching logic
    function switchTab(activeTab) {
      Object.values(tabs).forEach(tab => {
        tab.btn.classList.remove('active');
        tab.content.classList.remove('active');
      });
      
      tabs[activeTab].btn.classList.add('active');
      tabs[activeTab].content.classList.add('active');
      
      // Resize maps when switching tabs
      setTimeout(() => {
        if (activeTab === 'route') {
          google.maps.event.trigger(routeMap, 'resize');
        } else if (activeTab === 'parking') {
          google.maps.event.trigger(parkingMap, 'resize');
        }
      }, 100);
    }

    // Add event listeners for tabs
    tabs.route.btn.addEventListener('click', () => switchTab('route'));
    tabs.parking.btn.addEventListener('click', () => switchTab('parking'));

    // Authentication functions (same as before)
    function getTokensFromUrl() {
      debugLog('Checking URL for OIDC tokens');
      
      let params = new URLSearchParams(window.location.hash.substring(1));
      if (!params.has('access_token')) {
        params = new URLSearchParams(window.location.search);
      }
      
      const accessToken = params.get('access_token');
      const idToken = params.get('id_token');
      const tokenType = params.get('token_type');
      const expiresIn = params.get('expires_in');
      
      if (accessToken && idToken) {
        return { accessToken, idToken, tokenType: tokenType || 'Bearer', expiresIn: expiresIn ? parseInt(expiresIn) : 3600 };
      }
      return null;
    }

    function decodeJWT(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    function extractUserInfo(tokens) {
      let userInfo = { username: 'Demo User', email: null };
      
      try {
        if (tokens.idToken) {
          const payload = decodeJWT(tokens.idToken);
          if (payload) {
            userInfo.username = payload.name || payload.email || payload['cognito:username'] || 'Demo User';
            userInfo.email = payload.email;
          }
        }
      } catch (e) {
        debugLog('Error extracting user info', e);
      }
      
      return userInfo;
    }

    async function initAuth() {
      debugLog('Initializing authentication');
      
      // For demo purposes, simulate authentication
      isAuthenticated = true;
      userTokens = { accessToken: 'demo-token', idToken: 'demo-id-token' };
      
      const userInfo = { username: 'Demo User', email: 'demo@example.com' };
      
      userGreeting.innerHTML = `Welcome, <strong>${userInfo.username}</strong>`;
      logoutBtn.style.display = 'inline-block';
      authStatus.innerHTML = `‚úÖ Authenticated as ${userInfo.username}`;
      authSection.classList.add('authenticated');
      
      debugLog('Demo authentication successful');
    }

    function logout() {
      location.reload();
    }

    logoutBtn.addEventListener('click', logout);

    // Route Planning functionality
    const startLocationInput = document.getElementById('startLocationInput');
    const destinationInput = document.getElementById('destinationInput');
    const findRouteBtn = document.getElementById('findRouteBtn');
    const routeStatus = document.getElementById('routeStatus');
    const routeResults = document.getElementById('routeResults');

    findRouteBtn.addEventListener('click', calculateRoute);

    function calculateRoute() {
      const start = startLocationInput.value.trim();
      const destination = destinationInput.value.trim();

      if (!start || !destination) {
        routeStatus.innerText = '‚ùå Please enter both start location and destination.';
        routeStatus.className = 'error';
        return;
      }

      routeStatus.innerText = 'üîç Calculating route...';
      routeStatus.className = 'info';
      findRouteBtn.disabled = true;

      const request = {
        origin: start,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidTolls: document.getElementById('avoidToll').checked,
        provideRouteAlternatives: true
      };

      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          displayRouteResults(result);
          
          routeStatus.innerText = '‚úÖ Route calculated successfully!';
          routeStatus.className = 'success';
          routeResults.style.display = 'block';
          
          // If parking is included, search for parking near destination
          if (document.getElementById('includeParking').checked) {
            searchParkingNearDestination(result.routes[0].legs[0].end_location);
          }
        } else {
          routeStatus.innerText = `‚ùå Route calculation failed: ${status}`;
          routeStatus.className = 'error';
        }
        findRouteBtn.disabled = false;
      });
    }

    function displayRouteResults(result) {
      const routes = result.routes;
      const routesList = document.getElementById('routesList');
      
      let routesHTML = '';
      routes.forEach((route, index) => {
        const leg = route.legs[0];
        routesHTML += `
          <div class="route-item">
            <h5>üöó Route ${index + 1}</h5>
            <p>Distance: ${leg.distance.text} | Duration: ${leg.duration.text}</p>
            <p>Via: ${route.summary}</p>
            <button class="select-route-btn" onclick="selectRoute(${index})">Select This Route</button>
          </div>
        `;
      });
      
      routesList.innerHTML = routesHTML;
    }

    function selectRoute(routeIndex) {
      currentRoute = routeIndex;
      debugLog(`Selected route ${routeIndex}`);
      
      // Update the directions renderer to show selected route
      const newDirections = directionsRenderer.getDirections();
      newDirections.routes = [newDirections.routes[routeIndex]];
      directionsRenderer.setDirections(newDirections);
    }

    function searchParkingNearDestination(destination) {
      debugLog('Searching for parking near destination', destination);
      
      const request = {
        location: destination,
        radius: 1000,
        keyword: 'parking'
      };

      placesService.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          debugLog(`Found ${results.length} parking locations`);
          // Add parking markers to route map
          results.slice(0, 5).forEach(place => {
            new google.maps.Marker({
              position: place.geometry.location,
              map: routeMap,
              title: place.name,
              icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/parked_car.png',
                scaledSize: new google.maps.Size(32, 32)
              }
            });
          });
        }
      });
    }

    // Parking Search functionality
    const parkingLocationInput = document.getElementById('parkingLocationInput');
    const searchParkingBtn = document.getElementById('searchParkingBtn');
    const parkingSearchStatus = document.getElementById('parkingSearchStatus');
    const parkingResultsSection = document.getElementById('parkingResultsSection');
    const parkingResultsGrid = document.getElementById('parkingResultsGrid');

    searchParkingBtn.addEventListener('click', searchParking);

    function searchParking() {
      const location = parkingLocationInput.value.trim();
      
      if (!location) {
        parkingSearchStatus.innerText = '‚ùå Please enter a location.';
        parkingSearchStatus.className = 'error';
        return;
      }

      parkingSearchStatus.innerText = 'üîç Searching for parking spots...';
      parkingSearchStatus.className = 'info';
      searchParkingBtn.disabled = true;

      // Geocode the location first
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: location }, (results, status) => {
        if (status === 'OK') {
          const searchLocation = results[0].geometry.location;
          parkingMap.setCenter(searchLocation);
          parkingMap.setZoom(16);
          
          searchNearbyParking(searchLocation);
        } else {
          parkingSearchStatus.innerText = '‚ùå Location not found.';
          parkingSearchStatus.className = 'error';
          searchParkingBtn.disabled = false;
        }
      });
    }

    function searchNearbyParking(location) {
      // Clear existing markers
      parkingMarkers.forEach(marker => marker.setMap(null));
      parkingMarkers = [];

      const maxDistance = parseFloat(document.getElementById('maxDistanceSelect').value) * 1000;
      
      const request = {
        location: location,
        radius: maxDistance,
        keyword: 'parking'